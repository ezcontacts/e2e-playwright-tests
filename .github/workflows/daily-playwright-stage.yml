name: Daily Playwright-BDD Tests

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  desktop:
    name: Desktop Tests
    runs-on: ubuntu-latest
    continue-on-error: true

    env:
      CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
      CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
      ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      ENV: stage

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm ci
      - run: npx playwright install --with-deps
      - run: npm run desktop

      - name: Upload Desktop HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-html-desktop-${{ github.run_number }}
          path: |
            playwright-report/desktop
            playwright-report/desktop/assets
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload Desktop JSON report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-desktop-json
          path: reports/desktop/report.json

      - name: Send Desktop Slack report
        if: always()
        run: |
          JSON="reports/desktop/report.json"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          ARTIFACT_URL="$RUN_URL#artifacts"

          if [ ! -f "$JSON" ]; then
            echo "Playwright JSON report not found"
            exit 1
          fi

          PASSED=$(jq '[.. | objects | .results? // empty | .[] | select(.status=="passed")] | length' "$JSON")
          FAILED=$(jq '[.. | objects | .results? // empty | .[] | select(.status=="failed")] | length' "$JSON")
          SKIPPED=$(jq '[.. | objects | .results? // empty | .[] | select(.status=="skipped")] | length' "$JSON")
          TOTAL=$((PASSED + FAILED + SKIPPED))

          MESSAGE="*Playwright BDD ‚Äî Desktop*
          *ENV:* $ENV
          *Total:* $TOTAL
          ‚úÖ Passed: $PASSED
          ‚ùå Failed: $FAILED
          ‚è≠ Skipped: $SKIPPED

          <$ARTIFACT_URL|üì¶ Download report>"

          curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json; charset=utf-8" \
            --data "{\"channel\":\"C0A1W3PEFG9\",\"text\":\"$MESSAGE\"}" \
            https://slack.com/api/chat.postMessage

  mobile:
    name: Mobile Tests
    runs-on: ubuntu-latest
    needs: desktop
    continue-on-error: true

    env:
      CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
      CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
      ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      ENV: stage

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm ci
      - run: npx playwright install --with-deps
      - run: npm run mobile

      - name: Upload Mobile HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-html-mobile-${{ github.run_number }}
          path: |
            playwright-report/mobile
            playwright-report/mobile/assets
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload Mobile JSON report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-mobile-json
          path: reports/mobile/report.json

      - name: Send Mobile Slack report
        if: always()
        run: |
          JSON="reports/mobile/report.json"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          ARTIFACT_URL="$RUN_URL#artifacts"

          if [ ! -f "$JSON" ]; then
            echo "Playwright JSON report not found"
            exit 1
          fi

          PASSED=$(jq '[.. | objects | .results? // empty | .[] | select(.status=="passed")] | length' "$JSON")
          FAILED=$(jq '[.. | objects | .results? // empty | .[] | select(.status=="failed")] | length' "$JSON")
          SKIPPED=$(jq '[.. | objects | .results? // empty | .[] | select(.status=="skipped")] | length' "$JSON")
          TOTAL=$((PASSED + FAILED + SKIPPED))

          MESSAGE="*Playwright BDD ‚Äî Mobile*
          *ENV:* $ENV
          *Total:* $TOTAL
          ‚úÖ Passed: $PASSED
          ‚ùå Failed: $FAILED
          ‚è≠ Skipped: $SKIPPED

          <$ARTIFACT_URL|üì¶ Download report>"

          curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H "Content-Type: application/json; charset=utf-8" \
            --data "{\"channel\":\"C0A1W3PEFG9\",\"text\":\"$MESSAGE\"}" \
            https://slack.com/api/chat.postMessage
            
  merge-and-upload-xray:
    runs-on: ubuntu-latest
    needs: [desktop, mobile]
    env:
      XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
      XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
      JIRA_URL: ${{ secrets.JIRA_URL }}
      XRAY_TEST_EXECUTION_KEY: ${{ secrets.XRAY_TEST_EXECUTION_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: desktop-json
          path: reports/desktop/
      - uses: actions/download-artifact@v4
        with:
          name: mobile-json
          path: reports/mobile/
      - name: Merge & Aggregate JSON
        run: |
          node <<'EOF'
          const fs = require('fs');
          const desktop = JSON.parse(fs.readFileSync('reports/desktop/report.json'));
          const mobile = JSON.parse(fs.readFileSync('reports/mobile/report.json'));

          const allResults = [...desktop.results, ...mobile.results];
          const map = new Map();

          allResults.forEach(r => {
            const key = r.name.replace(/\[platform=.*?\]/, '').trim();
            if (!map.has(key)) map.set(key, r);
            else {
              const existing = map.get(key);
              existing.status = existing.status === 'failed' || r.status === 'failed' ? 'failed' : 'passed';
              existing.duration += r.duration;
            }
          });

          fs.writeFileSync('reports/final-report.json', JSON.stringify({ results: Array.from(map.values()) }, null, 2));
          EOF
      - name: Upload to Xray
        run: node scripts/upload-to-xray.js